<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wild About Physio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script>
</head>
<body>
    <script type="text/javascript">
        var SVGCmd = (function() {
            function SVGCmd() {
                this.commands = [];
            };

            var functions = [
                'M', 'L', 'H', 'V', 'C', 'S', 'Q', 'T', 'A', 'R',
                'm', 'l', 'h', 'v', 'c', 's', 'q', 't', 'a', 'r'
            ];
            
            for (var i = 0; i < functions.length; i++) {
                let f = functions[i];
                SVGCmd.prototype[f] = function() {
                    this.commands.push(
                        f + Array.prototype.slice.call(arguments).join(' ')
                    );
                    return this;
                };
            }

            SVGCmd.prototype.z = SVGCmd.prototype.Z = function() {
                this.commands.push('Z');
                return this;
            };

            SVGCmd.prototype.toString = function() {
                console.log(this.commands.join(''));
                return this.commands.join('');
            };

            SVGCmd.prototype.clear = function() {
                this.commands = [];
                return this;
            };

            return SVGCmd;
        }());

        var Point = (function() {
            function Point(x, y) {
                this.x = x;
                this.y = y;
            };

            Point.prototype.toString = function() {
                return this.x + ' ' + this.y;
            };

            return Point;
        }());

        var Vector = (function() {
            function Vector(p1, p2) {
                var _vx  = p2.x - p1.x;
                var _vy  = p2.y - p1.y;
                var _mag = Math.sqrt( Math.pow(_vx, 2) + Math.pow(_vy, 2) );

                Object.defineProperties(this, {
                    'p1':  {get: function() {return p1}},
                    'p2':  {get: function() {return p2}},
                    'vx':  {get: function() {return _vx}},
                    'vy':  {get: function() {return _vy}},
                    'mag': {get: function() {return _mag}},
                });
            };

            Vector.prototype.intersection = function(v2) {
                var v1 = this;
                var x = (
                    (v1.p1.x * v1.p2.y  -  v1.p1.y * v1.p2.x) *
                    (v2.p1.x - v2.p2.x) - (v1.p1.x - v1.p2.x) * 
                    (v2.p1.x * v2.p2.y  -  v2.p1.y * v2.p2.x)
                ) / (
                    (v1.p1.x - v1.p2.x) * (v2.p1.y - v2.p2.y) -
                    (v1.p1.y - v1.p2.y) * (v2.p1.x - v2.p2.x)
                );
                var y = (
                    (v1.p1.x * v1.p2.y  -  v1.p1.y * v1.p2.x) *
                    (v2.p1.y - v2.p2.y) - (v1.p1.y - v1.p2.y) *
                    (v2.p1.x * v2.p2.y  -  v2.p1.y * v2.p2.x)
                ) / (
                    (v1.p1.x - v1.p2.x) * (v2.p1.y - v2.p2.y) -
                    (v1.p1.y - v1.p2.y) * (v2.p1.x - v2.p2.x)
                );
                return new Point(x, y);
            };

            return Vector;
        }());

        var Coord = (function() {
            function Coord() {};

            Coord.prototype.scaleTo = function(s) {
                return function(v) { return v * s; };
            }

            Coord.prototype.polar = function(p, r, t) {
                var x = p.x + r * Math.cos(Math.PI * t / 180.0);
                var y = p.y - r * Math.sin(Math.PI * t / 180.0);
                return new Point(x, y);
            };

            /* Given the angle in degrees between two intersecting vectors,
                * and the radius of a circle to which the vectors must be
                * tangent, return the distance between the apex and the centre
                * of the circle.
                */
            Coord.prototype.circleCentreTTR = function(degrees, radius) {
                var radians = this.toRadians(degrees);
                var segment = radius / (Math.tan(radians / 2));
                return Math.sqrt(radius ** 2 + segment ** 2);
            };

            Coord.prototype.toDegrees = function(radians) {
                return radians * (180 / Math.PI);
            };

            Coord.prototype.toRadians = function(degrees) {
                return degrees * (Math.PI / 180);
            };

            Coord.prototype.fillet = function(p0, p1, p2, r) {
                var v1 = new Vector(p0, p1);
                var v2 = new Vector(p0, p2);

                // Bisect vector angle.
                var angle = (Math.atan2(v1.vy, v1.vx) - Math.atan2(v2.vy, v2.vx)) / 2;

                console.log('Angle: ' + this.toDegrees(angle));

                // The distance between the vertex and the tangent of the
                // circle.
                var segment = radius / Math.abs(Math.tan(angle));

                console.log('Segment: ' + segment);

                return segment;
            }

            Coord.prototype.intersection = function(v1, v2) {
                var x = (
                    (v1.p1.x * v1.p2.y  -  v1.p1.y * v1.p2.x) *
                    (v2.p1.x - v2.p2.x) - (v1.p1.x - v1.p2.x) * 
                    (v2.p1.x * v2.p2.y  -  v2.p1.y * v2.p2.x)
                ) / (
                    (v1.p1.x - v1.p2.x) * (v2.p1.y - v2.p2.y) -
                    (v1.p1.y - v1.p2.y) * (v2.p1.x - v2.p2.x)
                );
                var y = (
                    (v1.p1.x * v1.p2.y  -  v1.p1.y * v1.p2.x) *
                    (v2.p1.y - v2.p2.y) - (v1.p1.y - v1.p2.y) *
                    (v2.p1.x * v2.p2.y  -  v2.p1.y * v2.p2.x)
                ) / (
                    (v1.p1.x - v1.p2.x) * (v2.p1.y - v2.p2.y) -
                    (v1.p1.y - v1.p2.y) * (v2.p1.x - v2.p2.x)
                );
                return new Point(x, y);
            };

            return Coord;
        }());

        var palette = {
            dark_blue:  '#2d4a5c',
            dusky_pink: '#e29bb5',
            mint_green: '#70c5a0',
            light_blue: '#96c2d9',
            lilac:      '#a08dc2',
            coral:      '#f58c7b'
        };

        var colours = {
            head:       palette.dusky_pink,
            torso:      palette.dusky_pink,
            upper_legs: palette.dark_blue,
            lower_legs: palette.mint_green,
            feet:       palette.mint_green
        };

        function limb(s, centres, colour) {
            var t1, t2;
            if (centres[0].y < centres[1].y) {
                t1 = 30;
                t2 = 210;
            }
            else {
                t1 = 150;
                t2 = 330;
            }

            var svg = new SVGCmd;

            return s.path(
                svg.
                clear().
                M(coord.polar(centres[0], radius, t1)).
                A(radius, radius, t2, 0, 0, coord.polar(centres[0], radius, t2)).
                L(coord.polar(centres[1], radius, t2)).
                A(radius, radius, t1, 0, 0, coord.polar(centres[1], radius, t1)).
                z().
                toString()
            ).attr({fill: colour});
        }

        var s          = Snap(1000,600);
        var svg        = new SVGCmd();
        var coord      = new Coord();
        var scale      = coord.scaleTo(1);
        var ox         = scale(  0);
        var oy         = scale(300);
        var radius     = scale( 44);
        var dia        = radius * 2;
        var long_limb  = scale(147);
        var short_limb = scale(100);
        var head_torso = short_limb;

        // The SVG coordinate system has 0,0 at the top left.  The positive X
        // axis points right, and the positive Y axis points down.

        var height = function() {
            // The canvas height is the vertical distance between the centre of the
            // head and the centre of the torso base after having rotated it 300Â°,
            // plus the radius of the head and the radius of the torso base.
            var p = coord.polar(new Point(0, 0), head_torso + long_limb, 300);
            return p.y + dia;
        }();

        var centre = {};

        // The centre of the head is distance radius from the top left.
        centre.head = new Point(0 + radius, 0 + radius);

        centre.torso = [];
        centre.torso[0] = coord.polar(centre.head, head_torso, 300);
        centre.torso[1] = coord.polar(centre.head, head_torso + long_limb, 300);

        centre.upper_legs = [];
        centre.upper_legs[0] = centre.torso[1];
        centre.upper_legs[1] = coord.polar(centre.torso[1], long_limb, 60);

        centre.lower_legs = [];
        centre.lower_legs[0] = centre.upper_legs[1];
        centre.lower_legs[1] = coord.polar(centre.upper_legs[1], long_limb, 300);

        centre.feet = [];
        centre.feet[0] = centre.lower_legs[1];
        centre.feet[1] = coord.polar(centre.lower_legs[1], short_limb, 60);

        var head = s.circle(
            centre.head.x,
            centre.head.y,
            radius
        ).attr({fill: colours.head});

        var torso      = limb(s, centre.torso, colours.torso);
        var lower_legs = limb(s, centre.lower_legs, colours.lower_legs);
        var upper_legs = limb(s, centre.upper_legs, colours.upper_legs);
        var feet       = limb(s, centre.feet, colours.feet);
        
        var v1 = new Vector(
            coord.polar(centre.torso[0], radius, 210),
            coord.polar(centre.torso[1], radius, 210)
        );

        var v2 = new Vector(
            coord.polar(centre.upper_legs[0], radius, 150),
            coord.polar(centre.upper_legs[1], radius, 150)
        );

        // var i = coord.intersection(v1, v2);
        var i = v1.intersection(v2);

        s.path(
            svg.
            clear().
            M(v1.p1).
            L(i).
            L(v2.p2).
            toString()
        ).attr({stroke: "black", fill: "none"});

        s.circle(i.x, i.y, 5);

        var offset = coord.circleCentreTTR(60, radius);
        console.log('Offset: ' + offset);
        var c = coord.polar(i, offset, 90);

        s.circle(c.x, c.y, radius).attr({opacity: 0.25});

        s.circle(i.x, i.y, offset).attr({stroke: "black", fill: "none"});

        var segment = coord.fillet(i, v1.p1, v2.p1, radius);

        var c1 = coord.polar(i, segment, 120);

        s.circle(c1.x, c1.y, 5);

    </script>
</body>
</html>
